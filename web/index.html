<!DOCTYPE html>
<html>
  <head>
    <title>PlatypOUs GUI</title>
    
    <link
      type="text/css"
      rel="stylesheet"
      href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css"
    />
    <link
      type="text/css"
      rel="stylesheet"
      href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css"
    />
        
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  
  <body>
    <div id="app" class="small-container">
      <b-jumbotron header="PlatypOUs GUI">
        <b-form>
          <b-form-input v-model="value" type="range" min="-2.0" max="2.0" step="0.1" v-on:change="twistFunc"></b-form-input>
          <div class="mt-2">Value: {{ value }}</div>
          <b-button v-on:click="twistReset">Reset</b-button>
        </b-form>
        <b-table caption-top stacked :items="items">
          <template #table-caption>Odometry</template>
        </b-table>
      </b-jumbotron>
      
      <label style="font-size: x-large; text-indent: 30pt; line-height: 50px;">
        Live map:
      </label><br/>
      
      <label style="font-size: large; text-indent: 30pt; line-height: 20px;">
        Current goal:
      </label><br/>
      
      <p style="font-size: large; text-indent: 30pt; line-height: 20px;">X: {{ mouse_x }}</p>
      <p style="font-size: large; text-indent: 30pt; line-height: 20px;">Y: {{ mouse_y }}</p>

      <label style="font-size: large; text-indent: 30pt; line-height: 20px;">
        Click on the map to give a goal:
      </label>

      <canvas v-on:dblclick="getMousePos" v-on:mousedown="mouseDown" v-on:mouseup="mouseUp" v-on:mousemove="mouseMove" id="map_live" width="640" height="360" 
              style="border:1px solid #000000; margin: auto; padding: 0; display: block;"></canvas>

      <label for="camera_live" 
            style="font-size: x-large; text-indent: 30pt; line-height: 50px;">Live camera footage:</label>

      <canvas id="camera_live" width="640" height="360" 
              style="border:1px solid #000000; margin: auto; padding: 0; display: block;"></canvas>
              
    </div>
    
    <script>    
    
    var socket = io();
    
    var App = new Vue({
      el: '#app',
      data:{
        message: '',
        text: '',
        value: 0.0,
        x_pos: 0.0,
        y_pos: 0.0,
        lin_vel: 0.0,
        ang_vel: 0.0,
        mouse_x: 0.0,
        mouse_y: 0.0,
        goal_x: 0.0,
        goal_y: 0.0,
        map_offset_x: 0.0,
        map_offset_y: 0.0,
        map_moving: false,
        c: null,
        ctx: null,
        c_camera: null,
        ctx_camera: null,
        img: new Image(),
        map_img: new Image(),
        items: [
          { x_pos: 0.0, y_pos: 0.0, lin_vel: 0.0, ang_vel: 0.0}
        ]
      },
      
      mounted: function(){
        this.c = document.getElementById('map_live');
        this.ctx = this.c.getContext('2d');
        
        this.c_camera = document.getElementById('camera_live');
        this.ctx_camera = this.c_camera.getContext('2d');
      },
      
      methods:{
        twistFunc: function(){
          socket.emit('twist_message', this.value);
        },
        
        twistReset: function(){
          socket.emit('twist_message', 0.0);
          this.value = 0.0;
        },
        
        getMousePos: function (event) {
          this.mouse_x = event.offsetX - this.map_offset_x;
          this.mouse_y = event.offsetY - this.map_offset_y;
          
          this.sendGoal();
        },
        
        mouseDown: function (event) {
          this.mouse_x = event.offsetX - this.map_offset_x;
          this.mouse_y = event.offsetY - this.map_offset_y;
          this.map_moving = true;
        },
        
        mouseUp: function (event) {
          this.map_moving = false;
        },
        
        mouseMove: function (event) {
          if(this.map_moving){
            this.map_offset_x = event.offsetX - this.mouse_x;
            this.map_offset_y = event.offsetY - this.mouse_y;
            this.ctx.drawImage(this.map_img, this.map_offset_x, this.map_offset_y);
            this.drawGoal(this.goal_x + this.map_offset_x, this.goal_y + this.map_offset_y);
          }
        },
        
        drawGoal: function(x, y){
          this.ctx.beginPath();
          this.ctx.arc(x, y, 10, 0, 2 * Math.PI);
          this.ctx.stroke();
        },
        
        sendGoal: function(){
          var goal = new Object();
          goal.x = this.mouse_x;
          goal.y = this.mouse_y;
          socket.emit('goal', JSON.stringify(goal));
        }
        
      }
    })
    
    socket.on('x_pos', function(msg) {
      App.items[0].x_pos = msg;
    });
    
    socket.on('y_pos', function(msg) {
      App.items[0].y_pos = msg;
    });
    
    socket.on('lin_vel', function(msg) {
      App.items[0].lin_vel = msg;
    });
    
    socket.on('ang_vel', function(msg) {
      App.items[0].ang_vel = msg;
    });
  
    socket.on('robot-camera', function(data) {
      App.img.src = 'data:image/jpeg;base64, ' + data;
      App.ctx_camera.drawImage(App.img, 0, 0);
    });
    
    socket.on('robot-map', function(data) {
      App.map_img.src = 'data:image/jpeg;base64, ' + data;
      App.ctx.drawImage(App.map_img, App.map_offset_x, App.map_offset_y);
      App.drawGoal(App.goal_x + App.map_offset_x, App.goal_y + App.map_offset_y);
    });
    
    socket.on('draw', function(msg) {
      App.goal_x = JSON.parse(msg).x;
      App.goal_y = JSON.parse(msg).y;
      //~ App.ctx.drawImage(App.map_img, App.map_offset_x, App.map_offset_y);
      App.drawGoal(App.goal_x + App.map_offset_x, App.goal_y + App.map_offset_y);
    });
  
    </script>
  </body>
</html>
